<!DOCTYPE html>
<html>
<head>
	<title>Remote USB Gamepad Client</title>
	<script>
		socket = null;
		function on_connect() {
			address_input = document.getElementById('server-addr')
			console.log("Connecting to " + address_input.value)
			socket = new WebSocket(address_input.value);

			// Connection opened
			socket.addEventListener('open', function (event) {
				buffer = new ArrayBuffer(4);
				int_buf = new Uint32Array(buffer);
				url = new String(event.currentTarget.url)
				int_buf[0] = url[url.length - 2]
				event.currentTarget.send(buffer);

				document.getElementById('display').innerText = "Connected!"
			});

			// Listen for messages
			socket.addEventListener('message', function (event) {
			    console.log('Message from server ', event.data);
			});

			// Listen for socket closure
			socket.addEventListener('onclose', function (event) {
			    console.log("Socket " + socket.url + " closed")
			});
		}

		// Encode state into a binary buffer
		function encode_state(index) {
			buffer = new ArrayBuffer(16);
			int_buf = new Uint16Array(buffer);

			int_buf[0] = index | 0x8000 // Index, command ID
			int_buf[1] = 12 // Length

			int_buf[2] = 0 // Joystick 1 X Value
			int_buf[3] = 0 // Joystick 1 Y Value
			int_buf[4] = 0 // Joystick 2 X Value
			int_buf[5] = 0 // Joystick 2 Y Value

			int_buf[6] = 0 // Button state
			for (var i = 0; i < 2; i++) {
				button_input = document.getElementById("button" + i)
				if (button_input.checked) {
					int_buf[6] |= 1 << i
				}
			}

			return buffer
		}

		// Handler for when send button is clicked
		function on_send() {
			console.log("on_send")
			port_input = document.getElementById("port-number")
			message_input = document.getElementById("message")

			socket.send(encode_state(port_input.value))
		}
	</script>
</head>
<body>
	<label for="server-addr">Server address:</label>
	<input type="url" id="server-addr" name="server-addr" pattern="ws://.+" placeholder="ws://localhost:8000">

	<label for="port-number">Index:</label>
	<input type="number" id="port-number" name="port-number" min="0" max="1">
	
	<input type="checkbox" id="button0" name="button0">
	<label for="button0">Button 0</label>

	<input type="checkbox" id="button1" name="button1">
	<label for="button1">Button 1</label>

	<div id="display">Disconnected</div>
	<button type="button" onclick="on_connect()">Connect</button>
	<button type="button" onclick="on_send()">Send</button>
</body>
</html>